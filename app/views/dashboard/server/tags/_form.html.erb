<%= turbo_frame_tag "tag_form" do %>
  <dialog
    id="tagModal"
    class="bg-gray-800 rounded-lg max-w-2xl w-full"
    <%# data-controller="modal" %>
    <%# data-action="click->modal#closeOnBackdrop" %>
  >
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-white"><%= @title %></h3>
      <button data-action="click->modal#close" class="text-gray-400 hover:text-white">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </button>
    </div>

    <%= form_with model: [:dashboard, :server, tag], id: "tag_form_content", data: { turbo_frame: "_top" }, class: "space-y-4" do |form| %>
      <% if tag.errors.any? %>
        <div class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm">
          <ul class="list-disc list-inside space-y-1">
            <% tag.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div>
        <%= form.label :name,
                   t(".field.name"),
                   class: "block text-sm font-medium text-gray-300 mb-1" %>
        <%= form.text_field :name,
                        disabled: @read_only,
                        data: {
                          form_toggle_target: "field",
                        },
                        class:
                          "w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 #{"cursor-not-allowed opacity-60" if @read_only} #{"focus:outline-none focus:ring-2 focus:ring-blue-500" unless @read_only}",
                        placeholder: t(".field.name_placeholder") %>
      </div>

      <div>
        <%= form.label :content,
                   t(".field.content"),
                   class: "block text-sm font-medium text-gray-300 mb-1" %>
        <% if tag.persisted? && tag.image_url? %>
          <div class="mb-3">
            <img
              src="<%= tag.content.strip %>"
              alt="<%= tag.name %>"
              class="
                max-w-full max-h-64 object-contain rounded border border-gray-600
              "
            >
          </div>
        <% end %>
        <%= form.text_area :content,
                       rows: 4,
                       disabled: @read_only,
                       data: {
                         form_toggle_target: "field",
                       },
                       class:
                         "w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 #{"cursor-not-allowed opacity-60" if @read_only} #{"focus:outline-none focus:ring-2 focus:ring-blue-500" unless @read_only}",
                       placeholder: t(".field.content_placeholder") %>
      </div>

      <% if current_user.admin_or_mod? && tag.persisted? %>
        <!-- Admin Section Separator -->
        <hr class="border-gray-600">

        <div>
          <%= form.label :discord_uid,
                     t(".field.discord_uid"),
                     class: "block text-sm font-medium text-gray-300 mb-1" %>
          <%= text_field :tag,
          :discord_uid,
          value: params.dig(:tag, :discord_uid) || tag.user.discord_uid,
          disabled: @read_only,
          data: {
            form_toggle_target: "field",
          },
          class:
            "w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 #{"cursor-not-allowed opacity-60" if @read_only} #{"focus:outline-none focus:ring-2 focus:ring-blue-500" unless @read_only}",
          placeholder: t(".field.discord_uid_placeholder") %>
          <p class="text-xs text-gray-400 mt-1"><%= t(".field.current_owner", owner: tag.user.name) %></p>
        </div>
      <% end %>

      <div class="flex justify-end space-x-3 pt-4">
        <% if @read_only %>
          <% if can_edit_tag?(tag) %>
            <%= link_to t(".button.edit"),
            edit_dashboard_server_tag_path(tag),
            data: {
              turbo_frame: "tag_form",
            },
            class:
              "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" %>
          <% end %>
        <% else %>
          <%= form.submit @submit_text || t(".button.submit"),
                      class:
                        "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" %>
          <% if tag.persisted? %>
            <%= link_to t(".button.delete"),
            dashboard_server_tag_path(tag),
            method: :delete,
            data: {
              confirm: t(".button.delete_confirm"),
              turbo_method: :delete,
              form_toggle_target: "deleteButton",
            },
            class:
              "bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors" %>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </dialog>

  <%# This replaces Stimulus controller %>
  <script type="text/javascript">
    tagModal.showModal();
  </script>
<% end %>
